<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <title>Guillaume Coré (fridim) - personal page</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="StyleSheet" rev="StyleSheet" href="/pygments.css" type="text/css" />
  <!-- <link rel="StyleSheet" rev="StyleSheet" href="/bootstrap.min.css" type="text/css" /> -->
  <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css" integrity="sha384-4ZPLezkTZTsojWFhpdFembdzFudphhoOzIunR1wH6g1WQDzCAiPvDyitaK67mp0+" crossorigin="anonymous">
   <link rel="StyleSheet" rev="StyleSheet" href="/index.css" type="text/css" />

   <meta name="viewport" content="width=device-width, initial-scale=1">

</head>

<body>
  <div class="pure-g">
    <div class="pure-u-1-1">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga8ff1cd">1. LVM &lt;3</a>
<ul>
<li><a href="#orgcdc3364">1.1. Le plan de bataille</a></li>
<li><a href="#org1124033">1.2. Leçons apprises</a></li>
<li><a href="#org0b96b85">1.3. All in!</a></li>
</ul>
</li>
<li><a href="#orgec80665">2. Conclusion</a></li>
<li><a href="#org86ffd2b">3. Liens</a></li>
</ul>
</div>
</div>

<p><a id="orga8ff1cd"></a></p>
<h1>LVM &lt;3</h1>
<p>Il m'arrive encore de m'extasier sur des acquis de longue date. Aujourd'hui c'est LVM : c'est simple, solide, ça fonctionne, et ça rend bien service!</p>
<p>Ma (modeste) configuration actuelle comporte :</p>
<ul>
<li><code>/dev/md0</code>: 2 disques de 1To en RAID 1 md logiciel</li>
<li>LVM avec cet array comme PV</li>
</ul>
<p>Je suis content sauf que pour le raid1, j'ai utilisé les disques en entier directement plutôt que 2 partitions. Les disques étant exactement de même taille et modèle, ça n'a jamais posé de souci. Mais cela risque d'en poser un le jour où je dois changer un des disques pour un autre dont la capacité exacte me sera inconnue.</p>
<p>Lors de la création de la partition RAID, laisser une marge de 100M à la fin du disque évite d'avoir des soucis lorsqu'il faut changer un disque.</p>
<p>J'ai donc décidé de reconstruire mon raid avec des partitions. En plus c'est vendredi! Et parce que sinon c'est pas drôle, je le fais sans disque supplémentaire, ni backup. J'aurais aussi bien pu titrer « How to lose all your data in one day! ». Bon tanpis, on se lance :)</p>
<p><a id="orgcdc3364"></a></p>
<h2>Le plan de bataille</h2>
<ul>
<li>casser le raid des disques A et B en enlevant un disque, disons B</li>
<li>ajouter B comme PV du VG</li>
<li>évacuer tous les physical extents (PE) de l'array (qui ne contient plus que A) sur B    (durée: ~3h)</li>
<li>supprimer l'array des PVs</li>
<li>désassembler l'array</li>
<li>formatter A comme il faut</li>
<li>recréer l'array avec la partition de A</li>
<li>mettre l'array (qui n'a que A pour l'instant) dans le VG</li>
<li>évacuer tous les physical extents de B vers l'array    (durée: ~3h)</li>
<li>supprimer B des PVs</li>
<li>formatter B comme il faut</li>
<li>ajouter la partition de B dans l'array    (durée sync: ~3h)</li>
</ul>
<p>On est pas bien là ? Aucun souci, aucun risque! :P</p>
<p>J'ai complété après-coup en ajoutant la durée pour certaines opérations longues. Cela dépend évidemment de la taille et des performances des disques mais ça peut donner une idée.</p>
<p><a id="org1124033"></a></p>
<h2>Leçons apprises</h2>
<ul>
<li>bien wipe le début du disque qu'on retire du array car sinon LVM se plaint d'avoir des PV dupliqués trouvés.</li>
<li><strong>RTFM</strong> bien vérifier les options entre <code>sfdisk</code> et <code>sgdisk</code>. Ex: <code>sfdisk -d</code>  c'est pour dump, <code>sgdisk -d</code> c'est pour <code>--delete</code>. C'est complétement contre-intuitif, mais tout le monde regarde le man avant de faire quelque chose d'idiot non ?</li>
</ul>
<p><a id="org0b96b85"></a></p>
<h2>All in!</h2>
<div class="codehilite"><pre><span></span><code>mdadm --fail /dev/md0 /dev/sda
mdadm --remove /dev/md0 /dev/sda
mdadm --zero-superblock /dev/sda
pvcreate /dev/sda
vgextend vg0 /dev/sda
pvmove /dev/md0   <span class="c1">#start: 11:05   finish: 14:15   ~3h</span>
vgreduce vg0 /dev/md0
mdadm --stop /dev/md0
mdadm --remove /dev/md0
mdadm --zero-superblock /dev/sdb
gdisk  /dev/sdb
<span class="c1"># partition type FD00 hex code</span>
partprobe

mdadm --create --verbose --level<span class="o">=</span><span class="m">1</span> --metadata<span class="o">=</span><span class="m">1</span>.2 --raid-devices<span class="o">=</span><span class="m">2</span> /dev/md0 /dev/sdb1 missing
mdadm --detail --scan &gt;&gt; /etc/mdadm.conf
mdadm --assemble --scan

pvcreate /dev/md0
vgextend vg0 /dev/md0
pvmove /dev/sda
vgreduce vg0 /dev/sda

sgdisk /dev/sdb -R /dev/sda
sgdisk -G /dev/sda
partprobe
mdadm --add /dev/md0 /dev/sda1

grub-mkconfig
grub-install /dev/sda
</code></pre></div>

<p><a id="orgec80665"></a></p>
<h1>Conclusion</h1>
<p>Je suis content d'avoir bien noté et décrit toutes les étapes (dans le détail, important) avant de me lancer. Ça permet de valider que c'est faisable, de faire ressortir les incohérences aussi. Et puis c'est bien de ne pas perdre trop de temps lorsqu'on est sur une seule patte à utiliser les disques à fond.</p>
<p>En pratique, je n'ai eu <strong>AUCUN</strong> souci, bonne surprise! Quelques petites choses ont été ajoutées/modifées a posteriori, et elles sont toutes (les deux) dans "Leçons apprises".</p>
<p><a id="org86ffd2b"></a></p>
<h1>Liens</h1>
<ul>
<li><a href="https://wiki.archlinux.org/index.php/RAID">https://wiki.archlinux.org/index.php/RAID</a></li>
</ul><div id="disqus_thread"></div>
<script>

/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */
/*
var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//fridim.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<hr /><div id="footer">$&nbsp;from&nbsp;<a href="../notes/20170505-lvm.md">notes/20170505-lvm.md</a>&nbsp;
Tue&nbsp;Oct&nbsp;27&nbsp;10:41:31&nbsp;AM&nbsp;CET&nbsp;2020
&nbsp;$<br />Powered by <a href="/Makefile">Make</a> &amp; <a href="https://en.wikipedia.org/wiki/Markdown">Markdown</a> </div>

  </div>
  </div>
</body>
</html>
